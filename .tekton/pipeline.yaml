apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: cd-pipeline
spec:
  description: CI/CD Pipeline for ShopCarts microservice with deployment and BDD testing
  params:
    - name: APP_NAME
      description: Application name used for Kubernetes resources
      type: string
    - name: GIT_REPO
      description: Git repository to clone
      type: string
    - name: IMAGE_NAME
      description: Fully qualified image repository
      type: string
    - name: GIT_REVISION
      description: Git revision to build
      type: string
      default: main
    - name: BASE_URL
      description: The Route hostname for BDD testing (e.g., http://shopcarts-dev.apps.cluster.com)
      type: string
  workspaces:
    - name: pipeline-workspace
      description: Shared workspace for source, manifests, and build context
    - name: dockerconfig
      description: Docker registry config (config.json) for kaniko

  tasks:
    # Clone repository into shared workspace
    - name: clone
      taskRef:
        name: git-clone
        kind: Task
      params:
        - name: url
          value: $(params.GIT_REPO)
        - name: revision
          value: $(params.GIT_REVISION)
        - name: deleteExisting
          value: "true"
      workspaces:
        - name: output
          workspace: pipeline-workspace

    # Run pylint linting on the service code
    - name: lint
      runAfter:
        - clone
      taskRef:
        name: pylint
        kind: Task
      workspaces:
        - name: source
          workspace: pipeline-workspace

    # Build and push Docker image once using Tekton Hub kaniko Task,
    # tagging it with both the Git commit SHA and latest.
    - name: build-image
      runAfter:
        - unit-tests
      taskRef:
        name: kaniko
        kind: Task
      params:
        - name: IMAGE
          value: $(params.IMAGE_NAME):$(tasks.clone.results.commit)
        - name: EXTRA_ARGS
          value:
            - --destination=$(params.IMAGE_NAME):latest
      workspaces:
        - name: source
          workspace: pipeline-workspace
        - name: dockerconfig
          workspace: dockerconfig

    # Deploy the microservice to OpenShift
    - name: deploy
      runAfter:
        - build-image
      taskRef:
        name: deploy-task
        kind: Task
      params:
        - name: image-name
          value: $(params.IMAGE_NAME):$(tasks.clone.results.commit)
        - name: manifest-dir
          value: "k8s"
        - name: deployment-name
          value: $(params.APP_NAME)
      workspaces:
        - name: source
          workspace: pipeline-workspace
